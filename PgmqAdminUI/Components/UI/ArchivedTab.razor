@using PgmqAdminUI.Features.Messages
@using Microsoft.FluentUI.AspNetCore.Components
@inject Features.Messages.MessageService MessageService
@inject IMessageService NotificationService
@inject ILogger<ArchivedTab> Logger

<MessageGridTab TData="MessageDto"
                Title="Archived Messages"
                ContainerClass="archived-container"
                EmptyMessage="No archived messages."
                LoadDataAsync="LoadDataAsync"
                ItemsPerPage="20">
    <DesktopContent>
        <FluentDataGrid Items="@context.Items" Pagination="@context.Pagination" TGridItem="MessageDto">
            <PropertyColumn Property="@(m => m.MsgId)" Title="Message ID" Sortable="true" />
            <TemplateColumn Title="Message" Context="msg">
                <JsonViewer Content="@msg.Message" MaxLength="100" />
            </TemplateColumn>
            <PropertyColumn Property="@(m => m.EnqueuedAt)" Title="Created" Format="yyyy-MM-dd HH:mm:ss" Sortable="true" />
            <PropertyColumn Property="@(m => m.ReadCount)" Title="Read Count" Sortable="true" Align="Align.End" />
        </FluentDataGrid>
    </DesktopContent>
    <MobileCardContent>
        <div class="card-header">
            <span class="card-id">ID: @context.MsgId</span>
        </div>
        <div class="card-content">
            <JsonViewer Content="@context.Message" MaxLength="150" />
        </div>
        <div class="card-meta">
            <div class="meta-item">
                <span class="meta-label">Created</span>
                <span class="meta-value">@context.EnqueuedAt.ToString("yyyy-MM-dd HH:mm")</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Read Count</span>
                <span class="meta-value">@context.ReadCount</span>
            </div>
        </div>
    </MobileCardContent>
</MessageGridTab>

@code {
    [Parameter] public required string QueueName { get; set; }

    private async Task<(IReadOnlyList<MessageDto> Items, int TotalCount)> LoadDataAsync(int page, int pageSize)
    {
        try
        {
            var detail = await MessageService.GetArchivedMessagesAsync(QueueName, page, pageSize);
            return (detail.Messages, detail.Messages.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load archived messages for queue {QueueName}", QueueName);
            NotificationService.ShowMessageBar(options => {
                options.Intent = MessageIntent.Error;
                options.Body = $"Failed to load archived messages: {ex.Message}";
            });
            return (new List<MessageDto>(), 0);
        }
    }
}
