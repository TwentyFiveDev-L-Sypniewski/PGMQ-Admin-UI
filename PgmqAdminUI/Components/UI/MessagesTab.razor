@using PgmqAdminUI.Features.Messages
@using Microsoft.FluentUI.AspNetCore.Components
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons
@inject QueueService QueueService
@inject Features.Messages.MessageService MessageService
@inject IMessageService NotificationService
@inject ILogger<MessagesTab> Logger

<MessageGridTab @ref="_gridTab"
                TData="MessageDto"
                Title="Messages"
                ContainerClass="messages-container"
                EmptyMessage="No messages in this queue."
                LoadDataAsync="LoadDataAsync"
                ItemsPerPage="20">
    <DesktopContent>
        <FluentDataGrid Items="@context.Items" Pagination="@context.Pagination" TGridItem="MessageDto">
            <PropertyColumn Property="@(m => m.MsgId)" Title="Message ID" Sortable="true" />
            <TemplateColumn Title="Message" Context="msg">
                <JsonViewer Content="@msg.Message" MaxLength="100" />
            </TemplateColumn>
            <PropertyColumn Property="@(m => m.Vt)" Title="Visibility Timeout" Sortable="true" />
            <PropertyColumn Property="@(m => m.EnqueuedAt)" Title="Created" Format="yyyy-MM-dd HH:mm:ss" Sortable="true" />
            <PropertyColumn Property="@(m => m.ReadCount)" Title="Read Count" Sortable="true" Align="Align.End" />
            <TemplateColumn Title="Actions" Context="msg">
                <FluentButton Appearance="Appearance.Lightweight" OnClick="() => DeleteMessage(msg.MsgId)"
                              Title="Delete message">
                    <FluentIcon Value="@(new Icons.Regular.Size16.Delete())" />
                </FluentButton>
                <FluentButton Appearance="Appearance.Lightweight" OnClick="() => ArchiveMessage(msg.MsgId)"
                              Title="Archive message">
                    <FluentIcon Value="@(new Icons.Regular.Size16.Archive())" />
                </FluentButton>
            </TemplateColumn>
        </FluentDataGrid>
    </DesktopContent>
    <MobileCardContent>
        <MessageCard Data="context"
                     Type="MessageCardType.Message">
            <Actions>
                <FluentButton Appearance="Appearance.Lightweight" OnClick="() => DeleteMessage(context.MsgId)"
                              Title="Delete message">
                    <FluentIcon Value="@(new Icons.Regular.Size16.Delete())" /> Delete
                </FluentButton>
                <FluentButton Appearance="Appearance.Lightweight" OnClick="() => ArchiveMessage(context.MsgId)"
                              Title="Archive message">
                    <FluentIcon Value="@(new Icons.Regular.Size16.Archive())" /> Archive
                </FluentButton>
            </Actions>
        </MessageCard>
    </MobileCardContent>
</MessageGridTab>

@code {
    [Parameter] public required string QueueName { get; set; }

    private MessageGridTab<MessageDto>? _gridTab;

    private async Task<(IReadOnlyList<MessageDto> Items, int TotalCount)> LoadDataAsync(int page, int pageSize)
    {
        try
        {
            var detail = await QueueService.GetQueueDetailAsync(QueueName, page, pageSize);
            return (detail.Messages, detail.Messages.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load messages for queue {QueueName}", QueueName);
            NotificationService.ShowMessageBar(options => {
                options.Intent = MessageIntent.Error;
                options.Body = $"Failed to load messages: {ex.Message}";
            });
            return (new List<MessageDto>(), 0);
        }
    }

    private async Task DeleteMessage(long msgId)
    {
        try
        {
            await MessageService.DeleteMessageAsync(QueueName, msgId);
            NotificationService.ShowMessageBar(options => {
                options.Intent = MessageIntent.Success;
                options.Body = $"Message {msgId} deleted successfully";
            });
            await _gridTab?.RefreshAsync()!;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to delete message {MsgId}", msgId);
            NotificationService.ShowMessageBar(options => {
                options.Intent = MessageIntent.Error;
                options.Body = $"Failed to delete message: {ex.Message}";
            });
        }
    }

    private async Task ArchiveMessage(long msgId)
    {
        try
        {
            await MessageService.ArchiveMessageAsync(QueueName, msgId);
            NotificationService.ShowMessageBar(options => {
                options.Intent = MessageIntent.Success;
                options.Body = $"Message {msgId} archived successfully";
            });
            await _gridTab?.RefreshAsync()!;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to archive message {MsgId}", msgId);
            NotificationService.ShowMessageBar(options => {
                options.Intent = MessageIntent.Error;
                options.Body = $"Failed to archive message: {ex.Message}";
            });
        }
    }
}
