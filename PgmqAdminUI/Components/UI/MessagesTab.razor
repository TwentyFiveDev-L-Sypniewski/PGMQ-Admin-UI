@using PgmqAdminUI.Features.Messages
@using Microsoft.FluentUI.AspNetCore.Components
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons
@inject QueueService QueueService
@inject Features.Messages.MessageService MessageService
@inject IMessageService NotificationService
@inject ILogger<MessagesTab> Logger

<FluentStack Orientation="Orientation.Vertical">
    <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween">
        <h3>Messages</h3>
        <FluentButton Appearance="Appearance.Lightweight" OnClick="LoadMessagesAsync">
            Refresh
        </FluentButton>
    </FluentStack>

    @if (_loading)
    {
        <FluentProgressRing />
    }
    else if (_messages == null || !_messages.Any())
    {
        <FluentMessageBar Intent="MessageIntent.Info">
            No messages in this queue.
        </FluentMessageBar>
    }
    else
    {
        <div class="messages-container">
            <div class="desktop-view">
                <FluentDataGrid Items="@_messages" Pagination="@_pagination" TGridItem="MessageDto">
                    <PropertyColumn Property="@(m => m.MsgId)" Title="Message ID" Sortable="true" />
                    <TemplateColumn Title="Message">
                        <JsonViewer Content="@context.Message" MaxLength="100" />
                    </TemplateColumn>
                    <PropertyColumn Property="@(m => m.Vt)" Title="Visibility Timeout" Sortable="true" />
                    <PropertyColumn Property="@(m => m.EnqueuedAt)" Title="Created" Format="yyyy-MM-dd HH:mm:ss" Sortable="true" />
                    <PropertyColumn Property="@(m => m.ReadCount)" Title="Read Count" Sortable="true" Align="Align.End" />
                    <TemplateColumn Title="Actions">
                        <FluentButton Appearance="Appearance.Lightweight" OnClick="() => DeleteMessage(context.MsgId)"
                                      Title="Delete message">
                            <FluentIcon Value="@(new Icons.Regular.Size16.Delete())" />
                        </FluentButton>
                        <FluentButton Appearance="Appearance.Lightweight" OnClick="() => ArchiveMessage(context.MsgId)"
                                      Title="Archive message">
                            <FluentIcon Value="@(new Icons.Regular.Size16.Archive())" />
                        </FluentButton>
                    </TemplateColumn>
                </FluentDataGrid>
            </div>

            <div class="mobile-view">
                @foreach (var message in _messages)
                {
                    <FluentCard Class="message-card">
                        <div class="card-header">
                            <span class="card-id">ID: @message.MsgId</span>
                        </div>
                        <div class="card-content">
                            <JsonViewer Content="@message.Message" MaxLength="150" />
                        </div>
                        <div class="card-meta">
                            <div class="meta-item">
                                <span class="meta-label">Visibility Timeout</span>
                                <span class="meta-value">@message.Vt</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Created</span>
                                <span class="meta-value">@message.EnqueuedAt.ToString("yyyy-MM-dd HH:mm")</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Read Count</span>
                                <span class="meta-value">@message.ReadCount</span>
                            </div>
                        </div>
                        <div class="card-actions">
                            <FluentButton Appearance="Appearance.Lightweight" OnClick="() => DeleteMessage(message.MsgId)"
                                          Title="Delete message">
                                <FluentIcon Value="@(new Icons.Regular.Size16.Delete())" /> Delete
                            </FluentButton>
                            <FluentButton Appearance="Appearance.Lightweight" OnClick="() => ArchiveMessage(message.MsgId)"
                                          Title="Archive message">
                                <FluentIcon Value="@(new Icons.Regular.Size16.Archive())" /> Archive
                            </FluentButton>
                        </div>
                    </FluentCard>
                }
            </div>
        </div>

        <FluentPaginator State="@_pagination" />
    }
</FluentStack>

@code {
    [Parameter] public required string QueueName { get; set; }

    private IQueryable<MessageDto>? _messages;
    private bool _loading = true;
    private readonly PaginationState _pagination = new() { ItemsPerPage = 20 };
    private int _currentPage = 1;

    protected override async Task OnInitializedAsync()
    {
        await LoadMessagesAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (_messages == null)
            await LoadMessagesAsync();
    }

    private async Task LoadMessagesAsync()
    {
        try
        {
            _loading = true;
            var detail = await QueueService.GetQueueDetailAsync(QueueName, _currentPage, _pagination.ItemsPerPage);
            _messages = detail.Messages.AsQueryable();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load messages for queue {QueueName}", QueueName);
            NotificationService.ShowMessageBar(options => {
                options.Intent = MessageIntent.Error;
                options.Body = $"Failed to load messages: {ex.Message}";
            });
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task DeleteMessage(long msgId)
    {
        try
        {
            await MessageService.DeleteMessageAsync(QueueName, msgId);
            NotificationService.ShowMessageBar(options => {
                options.Intent = MessageIntent.Success;
                options.Body = $"Message {msgId} deleted successfully";
            });
            await LoadMessagesAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to delete message {MsgId}", msgId);
            NotificationService.ShowMessageBar(options => {
                options.Intent = MessageIntent.Error;
                options.Body = $"Failed to delete message: {ex.Message}";
            });
        }
    }

    private async Task ArchiveMessage(long msgId)
    {
        try
        {
            await MessageService.ArchiveMessageAsync(QueueName, msgId);
            NotificationService.ShowMessageBar(options => {
                options.Intent = MessageIntent.Success;
                options.Body = $"Message {msgId} archived successfully";
            });
            await LoadMessagesAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to archive message {MsgId}", msgId);
            NotificationService.ShowMessageBar(options => {
                options.Intent = MessageIntent.Error;
                options.Body = $"Failed to archive message: {ex.Message}";
            });
        }
    }
}
