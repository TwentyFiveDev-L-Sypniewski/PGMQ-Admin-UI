@using System.ComponentModel.DataAnnotations
@rendermode InteractiveServer
@inject QueueService QueueService
@inject NotificationService Notifications
@inject ILogger<CreateQueueDialog> Logger

<FluentDialog @bind-Open="IsOpen" Modal="true">
    <h3>Create New Queue</h3>
    <EditForm Model="@_model" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />

        <FluentStack Orientation="Orientation.Vertical">
            <FluentTextField @bind-Value="_model.Name" Label="Queue Name" Required />
            <ValidationMessage For="() => _model.Name" />

            <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.End">
                <FluentButton Appearance="Appearance.Neutral" OnClick="Cancel">Cancel</FluentButton>
                <FluentButton Appearance="Appearance.Accent" Type="ButtonType.Submit" Loading="@_submitting">
                    Create
                </FluentButton>
            </FluentStack>
        </FluentStack>
    </EditForm>
</FluentDialog>

@code {
    [Parameter] public bool IsOpen { get; set; }
    [Parameter] public EventCallback<bool> IsOpenChanged { get; set; }
    [Parameter] public EventCallback OnQueueCreated { get; set; }

    private CreateQueueModel _model = new();
    private bool _submitting = false;

    private async Task HandleSubmit()
    {
        try
        {
            _submitting = true;
            await QueueService.CreateQueueAsync(_model.Name);
            Notifications.ShowSuccess($"Queue '{_model.Name}' created successfully");

            await OnQueueCreated.InvokeAsync();
            await CloseDialog();
            ResetForm();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to create queue {QueueName}", _model.Name);
            Notifications.ShowError($"Failed to create queue: {ex.Message}");
        }
        finally
        {
            _submitting = false;
        }
    }

    private async Task Cancel()
    {
        await CloseDialog();
        ResetForm();
    }

    private async Task CloseDialog()
    {
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(IsOpen);
    }

    private void ResetForm()
    {
        _model = new CreateQueueModel();
    }

    public class CreateQueueModel
    {
        [Required(ErrorMessage = "Queue name is required")]
        [StringLength(100, MinimumLength = 1)]
        public string Name { get; set; } = "";
    }
}
